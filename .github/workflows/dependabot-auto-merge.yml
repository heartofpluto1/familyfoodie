name: Dependabot Auto-Merge
on: pull_request_target

permissions:
	pull-requests: write
	contents: write

jobs:
	dependabot:
		runs-on: ubuntu-latest
		if: github.actor == 'dependabot[bot]'
		steps:
			- name: Dependabot metadata
			  id: metadata
			  uses: dependabot/fetch-metadata@v2
			  with:
			  	github-token: '${{ secrets.GITHUB_TOKEN }}'

			- name: Approve Dependabot PR
			  run: gh pr review --approve "$PR_URL"
			  env:
			  	PR_URL: ${{ github.event.pull_request.html_url }}
			  	GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

			- name: Enable auto-merge for security updates
			  if: steps.metadata.outputs.alert-state == 'FIXED'
			  run: gh pr merge --auto --squash "$PR_URL"
			  env:
			  	PR_URL: ${{ github.event.pull_request.html_url }}
			  	GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

			- name: Enable auto-merge for patch updates
			  if: steps.metadata.outputs.update-type == 'version-update:semver-patch'
			  run: gh pr merge --auto --squash "$PR_URL"
			  env:
			  	PR_URL: ${{ github.event.pull_request.html_url }}
			  	GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
